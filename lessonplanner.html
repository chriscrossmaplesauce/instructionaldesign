<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Lesson Planner - Version 3.1</title>
<style>
body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background:#f3f4f6; margin:0; padding:20px; color:#1f2937; }
.container { max-width:1100px; margin:auto; background:white; padding:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
h1,h2,h3,h4{margin-top:0;}
.card { border-radius:10px; padding:16px; margin:12px 0; cursor:pointer; position:relative; color:white; background-size:cover; background-position:center; box-shadow:0 1px 4px rgba(0,0,0,0.3); overflow:hidden; transition:transform 0.2s, box-shadow 0.2s;}
.card:hover { transform: scale(1.03); box-shadow:0 4px 12px rgba(0,0,0,0.35); }
.card::after { content: ''; position: absolute; inset:0; background: rgba(0,0,0,0.4); border-radius:10px; }
.card h3, .card p { position: relative; z-index:1; }
textarea { width:100%; min-height:70px; border-radius:8px; border:1px solid #d1d5db; padding:8px; margin:6px 0; resize:vertical; font-family:inherit; }
input[type=text] { border-radius:6px; border:1px solid #d1d5db; padding:6px; width:100%; font-family:inherit; }
.button { background:#4f46e5; color:white; padding:10px 18px; border:none; border-radius:10px; cursor:pointer; margin:6px 0; font-size:14px; }
.button:hover { background:#4338ca; }
.lesson-event { border:1px solid #e5e7eb; padding:12px; margin:10px 0; border-radius:10px; background:#f9fafb; display:flex; gap:12px; align-items:flex-start; position:relative; }
.event-controls { display:flex; flex-wrap:wrap; gap:10px; margin-top:6px; align-items:flex-start; }
.suggestions { background:#eef2ff; padding:8px 12px; border-left:5px solid #4f46e5; border-radius:6px; margin-top:6px; }
.suggestions li { cursor:pointer; color:#4f46e5; margin-bottom:3px; display:inline-block; padding:4px 8px; border-radius:6px; background:#e0e7ff; }
.suggestions li:hover { background:#c7d2fe; text-decoration:none; }
.drag-handle { cursor:grab; font-size:20px; margin-right:10px; user-select:none; }
.media-label { display:flex; align-items:center; gap:4px; background:#f3f4f6; padding:4px 8px; border-radius:6px; font-size:13px; }
#return-btn { margin-bottom:16px; }
#lesson-planner { padding:10px; border-radius:12px; position:relative; }
h2.lesson-title { color:white; text-shadow: 1px 1px 4px rgba(0,0,0,0.7); }
@media (max-width:600px){ .event-controls{flex-direction:column;} }
</style>
</head>
<body>
<div class="container">
<h1>ðŸ“š Lesson Planner - Version 3.1</h1>

<button id="surprise-btn" class="button">ðŸŽ² Surprise Me!</button>
<a href="index.html" class="button" style="margin-bottom:12px;">  Home</a>

<button id="return-btn" class="button" style="display:none;">  Return to Main Page</button>
<div id="topic-selector"></div>
<div id="lesson-planner" style="display:none;"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<script>
// --------------------- Topics ---------------------
const topics=[
{name:"Life Cycles of Butterflies", subject:"Science", objectives:["Identify four stages of a butterfly life cycle","Sequence egg, caterpillar, chrysalis, butterfly","Describe what happens at each stage"], content:{stages:["Egg: laid on leaves","Caterpillar: eats & grows","Chrysalis: protective casing","Butterfly: adult emerges"]}, suggestions:{1:["Show time-lapse","Ask if seen butterflies","Play butterfly music"],2:["Display objectives","Repeat aloud","Explain goal"],3:["Recall other insects","Discuss caterpillar stages","Show short insect video"],4:["Present images","Explain terms","Show diagram"],5:["Use model","Sequence cards","Draw together"],6:["Draw life cycle","Label stages","Matching activity"],7:["Feedback","Correct misconceptions","Praise effort"],8:["Quiz","Explain to partner","Oral recap"],9:["Worksheet","Outdoor observation","Keep journal"]}, image:"butterflies.jpg"},
{name:"Plant Parts", subject:"Science", objectives:["Name roots, stem, leaves, flowers","Explain job of each part","Identify on real plants/pictures"], content:{parts:["Roots absorb water","Stem supports & transports","Leaves make food","Flowers produce seeds"]}, suggestions:{1:["Show plant video","Ask what plants need","Bring plant"],2:["Display objectives","Read aloud","Explain usefulness"],3:["Ask known parts","Discuss favorites","Show leaves"],4:["Show diagrams","Explain functions","Cross-section"],5:["Show real parts","Guide touching","Use magnifying glass"],6:["Label worksheet","Draw & color","Assemble cut-out"],7:["Feedback","Correct mistakes","Praise"],8:["Quick questions","Short quiz","Match parts"],9:["Observe at home","Record changes","Start journal"]}, image:"plants.jpg"},
{name:"Healthy Foods", subject:"Health", objectives:["Sort foods healthy/less healthy","Identify food groups","Explain why healthy foods help growth"], content:{foodGroups:["Fruits: vitamins","Vegetables: growth","Proteins: muscles","Grains: energy","Dairy: bones & teeth"]}, suggestions:{1:["Show pictures","Ask what they ate","Play song"],2:["Display objectives","Read aloud","Explain importance"],3:["Ask favorite foods","Discuss healthy","Recall last meal"],4:["Present groups","Explain role","Use pyramid"],5:["Sort pictures","Make posters","Guide grouping"],6:["Classify cards","Create meal plans","Plate sorting"],7:["Feedback","Correct mistakes","Praise"],8:["Quiz","Explain why healthy","Matching game"],9:["Food diary","Track weekly","Family challenge"]}, image:"fruits.jpg"},
{name:"Do-It-Yourself", subject:"Custom", objectives:["Enter your lesson objectives here..."], content:{customContent:["Enter key content here..."]}, suggestions:{1:["Add creative element","Group work","Link real-life"],2:["Add creative element","Group work","Link real-life"],3:["Add creative element","Group work","Link real-life"],4:["Add creative element","Group work","Link real-life"],5:["Add creative element","Group work","Link real-life"],6:["Add creative element","Group work","Link real-life"],7:["Add creative element","Group work","Link real-life"],8:["Add creative element","Group work","Link real-life"],9:["Add creative element","Group work","Link real-life"]}, image:"blocks.jpg"}
];

const nineEvents=[{id:1,title:"Gaining Attention"},{id:2,title:"Informing Learners of Objectives"},{id:3,title:"Stimulating Recall"},{id:4,title:"Presenting Content"},{id:5,title:"Providing Learning Guidance"},{id:6,title:"Eliciting Performance"},{id:7,title:"Providing Feedback"},{id:8,title:"Assessing Performance"},{id:9,title:"Enhancing Retention"}];

let selectedTopic=null;
const mediaOptions=["Video","Pictures","Charts","Physical Objects","Interactive Whiteboard","Worksheets","Songs/Audio","Role Play/Drama"];

// --------------------- Render Topics ---------------------
function renderTopics(){
  const container=document.getElementById("topic-selector"); container.innerHTML=""; container.style.display="block";
  document.getElementById("lesson-planner").style.display="none"; document.getElementById("return-btn").style.display="none";
  topics.forEach(topic=>{
    const div=document.createElement("div"); div.className="card";
    div.style.backgroundImage=`url('${topic.image}')`;
    div.innerHTML=`<h3>${topic.name}</h3><p>${topic.subject}</p><p><strong>Objective:</strong> ${topic.objectives[0]}</p>`;
    div.addEventListener("click",()=>{ selectedTopic=topic; showPlanner(); });
    container.appendChild(div);
  });
}
renderTopics();

// --------------------- Surprise Me ---------------------
document.getElementById("surprise-btn").addEventListener("click",()=>{
  selectedTopic=topics[Math.floor(Math.random()*topics.length)]; showPlanner();
});

// --------------------- Return ---------------------
document.getElementById("return-btn").addEventListener("click",()=>{ renderTopics(); });

// --------------------- Show Planner ---------------------
function showPlanner(){
  document.getElementById("topic-selector").style.display="none"; 
  const container=document.getElementById("lesson-planner"); container.style.display="block";
  document.getElementById("return-btn").style.display="inline-block";
  container.innerHTML=`<h2 class="lesson-title">${selectedTopic.name}</h2>`;
  container.style.position="relative";
  container.style.backgroundImage=`url('${selectedTopic.image}')`;
  container.style.backgroundSize="cover";
  container.style.backgroundPosition="center";
  container.style.backgroundRepeat="no-repeat";
  container.style.backgroundAttachment="fixed";

  nineEvents.forEach(event=>{
    const div=document.createElement("div"); div.className="lesson-event"; div.dataset.id=event.id; div.dataset.title=event.title;
    div.innerHTML=`<span class="drag-handle">â˜°</span><div style="flex:1;">
      <h4>${event.id}. ${event.title}</h4>
      <div class="event-controls">${mediaOptions.map((m,i)=>`<label class="media-label"><input type="checkbox" data-index="${i}">${m}</label>`).join('')}
      <label class="media-label">Other: <input type="text" class="other-text" placeholder="Your idea here"></label></div>
      <div class="suggestions"><strong>Suggestions:</strong><ul>${(selectedTopic.suggestions[event.id]||[]).map(s=>`<li>${s}</li>`).join('')}</ul></div>
      <textarea placeholder="How will you implement this event?"></textarea></div>`;
    container.appendChild(div);

    const textarea=div.querySelector("textarea"); 
    const checkboxes=div.querySelectorAll('input[type=checkbox]:not(.other-text)'); 
    const otherText=div.querySelector(".other-text");

    textarea.value=localStorage.getItem(`lesson_${selectedTopic.name}_${event.id}`)||"";
    const savedMedia=JSON.parse(localStorage.getItem(`lesson_${selectedTopic.name}_media_${event.id}`))||[];
    checkboxes.forEach((cb,i)=> cb.checked=savedMedia.includes(mediaOptions[i]));
    if(savedMedia.some(m=>typeof m==="string")) { otherText.value=savedMedia.find(m=>typeof m==="string"); }

    textarea.addEventListener("input",()=>{ localStorage.setItem(`lesson_${selectedTopic.name}_${event.id}`,textarea.value); });
    checkboxes.forEach((cb,i)=> cb.addEventListener("change",()=>{ saveMedia(event.id); }));
    otherText.addEventListener("input",()=>{ saveMedia(event.id); });

    function saveMedia(eventId){
      let selected=Array.from(checkboxes).map((cb,i)=>cb.checked?mediaOptions[i]:null).filter(x=>x!==null);
      if(otherText.value.trim()!=="") selected.push(otherText.value.trim());
      localStorage.setItem(`lesson_${selectedTopic.name}_media_${eventId}`,JSON.stringify(selected));
    }

    div.querySelectorAll(".suggestions li").forEach(li=>{ li.addEventListener("click",()=>{ textarea.value=li.textContent; localStorage.setItem(`lesson_${selectedTopic.name}_${event.id}`,textarea.value); }); });
  });

  Sortable.create(container,{handle:".drag-handle", animation:150});

  // ----- Fixed PDF Export -----
  const exportBtn=document.createElement("button"); 
  exportBtn.className="button"; 
  exportBtn.textContent="Export to PDF";

  exportBtn.addEventListener("click",()=>{
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const cleanTopicName = selectedTopic.name.replace(/[^\x00-\x7F]/g,"");
    doc.setFontSize(16); 
    doc.text(`Lesson Planner: ${cleanTopicName}`, 10, 10);

    const rows = Array.from(container.querySelectorAll(".lesson-event")).map(div=>{
      const title = div.dataset.title.replace(/[^\x00-\x7F]/g,""); 
      const textarea = div.querySelector("textarea").value.replace(/[^\x00-\x7F]/g,""); 

      const mediaArr = Array.from(div.querySelectorAll('input[type=checkbox]:not(.other-text)'))
        .filter(cb=>cb.checked)
        .map(cb=> cb.parentElement.textContent.replace(/[^\x00-\x7F]/g,"").trim());

      const otherText = div.querySelector(".other-text").value.replace(/[^\x00-\x7F]/g,"").trim();
      if(otherText !== "") mediaArr.push(otherText);

      return [title, mediaArr.join(", "), textarea];
    });

    doc.autoTable({
      startY: 20,
      head: [["Event", "Media", "Prescription"]],
      body: rows,
      styles: { fontSize: 10, cellPadding: 3 },
      headStyles: { fillColor: [100,149,237], textColor: 255 },
      theme: 'grid',
      columnStyles: {0:{cellWidth:50},1:{cellWidth:50},2:{cellWidth:90}}
    });

    doc.save(`${cleanTopicName}_LessonPlanner.pdf`);
  });

  container.appendChild(exportBtn);
}
</script>
</div>
</body>
</html>
